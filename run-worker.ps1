# Job Queue Worker - PowerShell Script
# Runs the background worker every 60 seconds to process pending jobs

Write-Host "üöÄ Starting Job Queue Worker..." -ForegroundColor Green
Write-Host "Press Ctrl+C to stop" -ForegroundColor Yellow
Write-Host ""

$workerUrl = "http://localhost:4000/api/jobs/worker"
$interval = 60 # seconds

while ($true) {
    try {
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        Write-Host "[$timestamp] Calling worker endpoint..." -ForegroundColor Cyan
        
        $response = Invoke-RestMethod -Uri $workerUrl -Method GET -ErrorAction Stop
        
        if ($response.success) {
            $processed = $response.processedCount
            $failed = $response.failedCount
            
            if ($processed -gt 0 -or $failed -gt 0) {
                Write-Host "  ‚úÖ Processed: $processed jobs" -ForegroundColor Green
                if ($failed -gt 0) {
                    Write-Host "  ‚ùå Failed: $failed jobs" -ForegroundColor Red
                }
            } else {
                Write-Host "  ‚ÑπÔ∏è  No jobs in queue" -ForegroundColor Gray
            }
        } else {
            Write-Host "  ‚ö†Ô∏è  Worker returned error" -ForegroundColor Yellow
        }
        
    } catch {
        Write-Host "  ‚ùå Error calling worker: $($_.Exception.Message)" -ForegroundColor Red
    }
    
    Write-Host "  ‚è±Ô∏è  Waiting $interval seconds..." -ForegroundColor Gray
    Start-Sleep -Seconds $interval
}
